"use strict";
require.config(requireConfig),require(["jquery","tmpl","i18n","bootstrap","common","star"],function(e,t,n,i,r,a){function o(t,n){e("#orderId").html(t),r.dao.getOrderDetail({orderId:t},function(t){y=[],null==x&&(x=1!=t.cmtTpe),e("#orderDate").html(r.util.formatOrderDateTime(t.crTime));var i=r.util.getCurrencySymbol(t.correncyCode);i||(i=r.util.getCurrencySymbol(r.util.getLocalCurrency()));var a=r.util.getAdvSource().u;a||(a=r.util.getQueryString("u"));var o="";a&&(o="?u="+a);for(var l=r.util.encodeMenuType(r.util.getUvid()),m=0;m<t.spCart.length;m++){var s=t.spCart[m];s.displayImg=r.util.picUrl+s.displayImg,s.productPrice=r.util.formatProductPrice(s.productPrice,i);var c=r.util.formatProductName(s.productName)+"-d-"+r.util.encodeMenuType(s.productId)+"-"+r.util.encodeMenuType(s.productColorId)+"-"+l+".html"+o;s.href=c,x?L?s.zjcmId&&"0"!=s.zjcmId||L!=s.productColorId||(s.serverImageList=[],s.imageList=[],y.push(s)):s.zjcmId&&"0"!=s.zjcmId||(s.serverImageList=[],s.imageList=[],y.push(s)):s.cmId&&"0"!=s.cmId||(s.serverImageList=[],s.imageList=[],y.push(s))}f(),n&&0==y.length&&(e("#submit_comment_success_mask").addClass("hide"),""===document.referrer?window.location.href="/":window.history.go(-1))})}function l(t){for(var n=0;n<t.length;n++)x?e("#comment_star_input_"+n).parent().parent().addClass("hide"):e("#comment_star_input_"+n).rating({step:1,size:"xs",showClear:!1,min:0,max:5,showCaption:!1}).rating("update",5),e("#cart_list #comment_content_input_"+n).attr("placeholder",e.i18n.map.CommentContentPlaceHolder),e("#cart_list #comment_video_input_"+n).attr("placeholder",e.i18n.map.CommentVideoPlaceHolder),e("#upload_input_"+n).change(function(){var n=e(this)[0].id;R=Number(n.substring(n.lastIndexOf("_")+1)),console.log("updateInputIndex = "+R);var i=null,r=document.getElementById("upload_input_"+R);if(r.files)i=r.files[0],s(i);else{r.select(),r.blur();var a=document.selection.createRange().text;console.log("filePath = "+a),t[R].imageList.push(a),v()}}),I(n,500),e("#comment_content_input_"+n).bind("input propertychange",function(){var t=e(this)[0].id;I(Number(t.substring(t.lastIndexOf("_")+1)),500-e(this).val().length)})}function m(e,t){h(g(e,t))}function s(t){t.size>b?(alert(e.i18n.map.CommentMaxFileSize),e("#upload_input_"+R).val("")):t.size>w?(c(t),u(t,m)):(c(t),d(t,m))}function c(e){var t=window.URL||window.webkitURL,n=t.createObjectURL(e);y[R].imageList.push(n),v()}function d(e,t){var n=new FileReader;n.onload=function(){var i=n.result;t(i,e.name)},n.readAsDataURL(e)}function u(t,n){if("undefined"==typeof FileReader)console.log("The current browser kernel does not support base64 image compression"),d(t,n);else try{var i=new FileReader;i.onload=function(i){var r=e("<img/>");r.load(function(){var e=this.height/(this.width/300),i=document.createElement("canvas"),r=i.getContext("2d"),a=0,o=0,l=0,m=0,s="";i.width=300,i.height=e,r.clearRect(0,0,300,e),this.width>300?(a=Math.round(300),o=e,l=Math.round((a-300)/2)):(o=Math.round(e),a=300,m=Math.round((o-e)/2)),r.drawImage(this,l,m,a,o);var s=i.toDataURL("image/jpeg");n(s,t.name)}),r.attr("src",i.target.result)},i.readAsDataURL(t)}catch(e){console.log("Compression failed!"),d(t,n)}}function g(e,t){for(var n=e.split(","),i=n[0].match(/:(.*?);/)[1],r=atob(n[1]),a=r.length,o=new Uint8Array(a);a--;)o[a]=r.charCodeAt(a);return new File([o],t,{type:i})}function p(t){y[R].serverImageList.push(t),e("#comment_image_list_"+R+" .comment-image-item:last-child").find(".icon-spinner").addClass("hide")}function h(t){console.log("updateImage");var n=new FormData;n.append("file",t),r.dao.uploadCommentImg(n,function(e){p(e)},null,function(){e("#upload_input_"+R).val("")})}function _(e){e&&0!=e.length&&r.dao.delCommentImg({inputParams:JSON.stringify(e)},function(){if(1==e.length){for(var t=e[0],n=-1,i=0;i<y[R].serverImageList.length;i++)if(t==y[R].serverImageList[i]){n=i;break}-1!==n&&(y[R].serverImageList.splice(n,1),y[R].imageList.splice(n,1),v(!0))}else for(var i=0;i<y.length;i++)y[i].serverImageList=[],y[i].imageList=[]})}function f(){e("#cart_list").html(e("#cartTempl").tmpl(y)),e("#cart_list #color_title").html(e.i18n.map.ColorTitle),e("#cart_list #rating_label").html(e.i18n.map.CommentRatingLabel),e("#cart_list #content_label").html(e.i18n.map.CommentContentLabel),e("#cart_list #video_label").html(e.i18n.map.CommentVideoLabel),l(y)}function v(t){var n=y[R].imageList;n&&n.length>0?(e("#comment_image_list_"+R).html(e("#commentImageTempl").tmpl(n)),t||e("#comment_image_list_"+R+" .comment-image-item:last-child").find(".icon-spinner").removeClass("hide"),e("#comment_image_list_"+R).removeClass("hide"),e("#comment_image_list_"+R+" .icon-close").each(function(){e(this).click(function(){var t=e(this).parent().parent()[0].id;R=Number(t.substring(t.lastIndexOf("_")+1));for(var n=e(this).parent().find("img")[0].src,i=-1,r=0;r<y[R].imageList.length;r++)if(n==y[R].imageList[r]){i=r;break}if(-1!==i){_([y[R].serverImageList[i]])}})}),3==n.length&&e("#update_layout_"+R).addClass("hide")):e("#comment_image_list_"+R).addClass("hide")}function I(t,n){var i=e.i18n.map.CommentContentHint;i=i.replace("%",n);var r=i.substring(0,i.indexOf(n)),a=i.substring(i.indexOf(n)+ +(""+n).length,i.length);e("#word_number_"+t).html(r+"<span class='red'>"+n+"</span>"+a)}r.initLoginStatus();var C=r.util.getQueryString("id"),L=r.util.getQueryString("productColorId"),b=4194304,w=102400,y=[],R=0,x=null;!function(){window.onbeforeunload=function(e){for(var t=[],n=0;n<y.length;n++){var i=y[n].serverImageList;i&&i.length>0&&(t=t.concat(i))}t.length>0&&_(t)},e("#addCommentBtn").click(function(){var t=r.util.getUserId();if(!t)return void(window.location.href="../../../login.html");for(var n=[],i=[],a=0;a<y.length;a++){var o=y[a],l=e("#comment_star_input_"+a).val(),m=e("#comment_content_input_"+a).val();if(x&&(l="5"),l&&m){var s={shareimgs:y[a].serverImageList,sharevideo:"",videourl:e("#comment_video_input_"+a).val(),orderId:C,productId:o.productId,productColorId:o.productColorId,cmId:o.cmId&&"0"!==o.cmId?o.cmId:null,attrDes:o.attrDes,tEval:x?null:l,content:m,userId:t};n.push(s)}else y[a].serverImageList&&y[a].serverImageList.length>0&&(i=i.concat(y[a].serverImageList))}if(0==n.length)return void alert("请至少填写一个商品的评分和评价内容");var c=n;r.dao.submitComment({inputParams:JSON.stringify(c)},function(){e("#submit_comment_success_mask").removeClass("hide"),_(i)})}),e("#confirmBtn").click(function(){e("#submit_comment_success_mask").addClass("hide"),o(C,!0)})}(),o(C)});